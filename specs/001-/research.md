# research.md (阶段 0)

## 决策与理由

### 外网验证方式
- 决策: 暂使用本机路由器端口映射或 Tailscale/VPN 任选其一
- 理由: 快速、无需采购云主机
- 备选: 临时云服务器 (额外成本与配置时间)

### HTTP 错误策略
| 情况 | 行为 | 理由 | 备选 |
|------|------|------|------|
| 畸形首行 | 立即关闭连接 | 简化实现，防止模糊状态 | 返回 400 (需要统一错误响应生成) |
| 未知方法 | 返回 501 | 明确告知未实现 | 405 (需维护允许方法列表) |
| 头超长 | 关闭连接 | 防止内存滥用 | 返回 431 (更标准，但需错误响应机制) |

### 头/Buffer 上限
- 决策: 单请求行 ≤ 8KB；单头字段 ≤ 4KB；总头部 ≤ 32KB；Buffer 最大 1MB 扩容倍增
- 备选: 固定大小循环缓冲 (减少 realloc，但降低灵活性)

### 必需配置字段
| 字段 | 描述 | 错误形式 |
|------|------|----------|
| port | 监听端口 | 缺失→FATAL: missing 'port' |
| log_level | 日志级别阈值 | 缺失→WARN 使用默认 INFO |
| timeout_seconds | 连接空闲超时 | 缺失→默认 60s |

### 日志格式
- 格式: `<ISO8601> <LEVEL> <COMPONENT> - <MESSAGE>`  (示例: 2025-09-11T10:05:03Z INFO EventBase - loop started)
- 级别集合: TRACE, DEBUG, INFO, WARN, ERROR
- 时间格式: UTC ISO8601

### CPU 阈值
- 决策: 空闲时单核 < 5% (以 5s 采样平均)；轻负载 (<10 并发连接) < 25%
- 测量: 使用 `top -l 1` (macOS) 或 `ps` 取样，后续可脚本自动化

### CI 方案
- 决策: 后续添加 GitHub Actions workflow (构建 + 运行测试 + 冒烟)
- 备选: 本地脚本手动执行 (无自动反馈)

## 未解决项
(无 — 已为阶段 1 做好准备)
