# 功能规格: 项目全面测试方案（非压力测试）

**功能分支**: `001-`  
**创建日期**: 2025-09-11  
**状态**: 草稿  
**输入**: 用户描述: "为整个项目制定一个相对全面但非压力/负载的测试方案，验证：1) 在本地网络与真实外网环境可运行；2) 各个模块/文件达到预期功能。"

## 执行流程 (主流程)
```
1. 解析用户描述 → 若为空报错 "未提供功能描述"
2. 提取关键概念 → 覆盖范围(网络运行/功能正确性/非压力)、模块清单、环境维度、验证方式
3. 针对不明确之处标记 [需要澄清: 问题]
4. 形成用户场景与测试路径 → 若无法形成主线用户旅程则错误 "无法确定用户场景"
5. 生成功能需求 (均需可测试、可判定通过/失败)
6. 识别关键实体: 测试环境、组件、用例、期望结果
7. 审查清单自检 → 若仍有 [需要澄清] 给出不确定性提示
8. 规格完成用于后续编写详细测试计划与测试代码
```

---

## ⚡ 快速指南
- ✅ 聚焦“需要验证的行为”与“可观测结果”
- ❌ 不写工具/框架具体实现细节 (如 gtest 具体宏、脚本命令实现)
- 👥 面向关注质量与交付风险的相关者

### 章节要求
- 所有强制性章节已包含
- 与本功能相关：数据实体（测试对象抽象）
- 无关章节已去除

### AI 生成指南落地说明
本规格对以下仍不明确部分使用标记：
- 外网验证方式是否允许端口映射还是需要部署到云主机 → [需要澄清: 外网验证承载方式?]
- “各个文件达到预期” 需有期望规范来源（代码注释 / README / 内部设计文档） → [能够成功运行即达到预期]
- 是否需要在 Windows / Linux / macOS 三平台都进行多路复用器测试 → [MacOs]

---

## 用户场景与测试 *(强制性)*

### 主要用户故事
作为项目维护者，我需要一套系统化的功能与运行环境验证流程，使我能在不进行压力/性能极限测试的前提下：
1. 确认 HTTP/TCP 服务器可在单机回环、本地局域网不同主机、以及可选的真实公网访问场景中成功建立连接、收发请求并返回预期响应。
2. 确认各核心事件驱动组件（事件循环、IO 多路复用封装、Channel、Buffer、连接与超时管理、配置加载、日志、消息处理、HTTP 解析）在典型正常与常见异常输入下表现正确并维持资源安全（无崩溃、释放得当、无明显阻塞）。
3. 在日常合并前快速回归 (目标执行时间 < 10 分钟) 获得“功能健康”信号。

### 验收场景
1. 假如 启动 HTTP 服务器于 127.0.0.1:PORT，当 以 curl/本地客户端发送合法 GET 请求，那么 返回状态行 200 且包含约定响应体(示例: Hello / Echo 内容匹配)。
2. 假如 在同一局域网另一台主机通过服务器局域网 IP:PORT 发出相同请求，当 网络允许基础互通，那么 获得与本机一致响应且日志记录到来访 IP。
3. 假如 发送畸形 HTTP 首行 (缺少方法或路径)，当 服务器解析该请求，那么 服务器关闭该连接或返回 4xx (行为需明确) 且不导致进程崩溃。
4. 假如 建立多个(例如 50) 顺序 TCP 连接并即时关闭，当 连接管理器处理它们，那么 所有连接最终进入已释放状态且无内存泄漏(通过工具或统计计数校验)。
5. 假如 修改配置文件中的端口后重启，当 重新读取配置，那么 服务器在新端口监听且日志输出更新信息。
6. 假如 触发超时逻辑 (空闲连接超过设定时间)，当 定时轮询执行，那么 超时连接被清理且不会接收后续数据。
7. 假如 选择使用不同 IO 多路复用实现 (select / epoll / kqueue / IOCP 取决于平台)，当 编译并运行冒烟用例，那么 事件循环能接受至少一个连接并完成一次读写交互。

### 边界情况
- 当 接收到超大但低于上限的请求头时如何处理? [需要澄清: 头部大小上限值?]
- 当 Buffer 满或接近容量阈值是否扩容还是返回错误? [扩容]
- 未知/不支持的 HTTP 方法是否统一返回 405/501 还是直接关闭连接? [需要澄清]
- 端口被占用时启动行为 (重试? 退出? 日志级别?) [需要澄清]
- 配置文件缺失或格式错误处理策略 [需要澄清]

## 需求 *(强制性)*

### 功能需求
- **FR-001**: 测试计划必须覆盖三类网络运行模式：本机回环、同局域网跨主机、可选公网访问 (若可用)。若公网不可行需记录原因。
- **FR-002**: 必须验证 HTTP 服务器对合法 GET 请求返回正确状态码与响应体 (基线用例最少 1 个)。
- **FR-003**: 必须验证对至少 3 类典型异常请求（畸形首行、缺失 Host、超长行）服务器行为符合定义并无崩溃。 [需要澄清: 期望错误响应码策略]
- **FR-004**: 必须验证 TCP 服务器可建立连接、发送一段数据、按协议回显或处理，并正常关闭。
- **FR-005**: 必须对事件循环在有与无活跃连接时保持 CPU 占用低于阈值 (例如 <15% 单核)。 [需要澄清: 实际阈值]
- **FR-006**: IO 多路复用抽象需在目标平台至少使用一种实现运行通过冒烟测试 (连接、发送、接收)。
- **FR-007**: Buffer 组件需通过：写入/读取/部分读取/边界长度/清空 操作序列测试，保持数据顺序与长度正确。
- **FR-008**: BufferEvent / Channel 必须在文件描述符关闭后不再触发回调。
- **FR-009**: ConnectionManager 在批量创建与关闭连接测试后未留下悬挂引用 (可用内部计数或工具检测)。
- **FR-010**: 超时管理 (TimeOutServer 或相关模块) 必须在超时阈值后清理连接并生成日志条目。
- **FR-011**: 配置加载 (Configure) 必须在合法配置文件下解析所有关键项并在缺失必需字段时报出明确错误。 [需要澄清: 必需字段清单]
- **FR-012**: 日志模块 (MiniEventLog) 必须输出包含时间戳、级别、消息、来源组件信息的行格式 (字段顺序需定义)。 [需要澄清: 格式规范]
- **FR-013**: 消息处理 (HTTPServerMsgHandler / TCPMsgHandler) 必须对正常与异常消息路径提供可判定输出或错误日志。
- **FR-014**: 所有测试执行总时间目标 < 10 分钟 (在参考硬件环境). [需要澄清: 基准硬件]
- **FR-015**: 测试体系不包含压力/高并发极限场景 (> 100 并发连接)；若意外超过需标记并拆分到性能计划。
- **FR-016**: 必须提供最少 1 个端到端 (E2E) 冒烟脚本，可一键启动服务器、发请求、断言响应并退出 0/非 0 状态。
- **FR-017**: 必须在 CI (若存在) 可执行：编译→单元/组件测试→冒烟用例。 [需要澄清: 现有 CI 是否配置?]
- **FR-018**: 需列出模块覆盖追踪矩阵 (模块 vs 测试类型) 以便后续补齐缺口。
- **FR-019**: 失败用例需输出最少上下文：期望值、实际值、步骤描述。
- **FR-020**: 规格完成前所有 [需要澄清] 条目需被解决或转换为明确假设，并记录在假设区。

### 关键实体
- **测试环境(TestEnvironment)**: 描述操作系统/网络拓扑/可用多路复用实现集合。
- **组件(Component)**: 项目中可独立被验证的功能单元 (HTTPServer, TCPServer, EventBase, MultiplexerSelector, Buffer, Channel, ConnectionManager, Configure, MiniEventLog, MessageHandler)。
- **用例(TestCase)**: 针对单一需求的可执行验证步骤集合，具有前提、操作、断言、结果。
- **冒烟场景(SmokeScenario)**: 快速覆盖核心链路(启动→连接→请求→响应→关闭)。
- **假设(Assumption)**: 在需求未完全澄清前暂时采用的前置条件或限制。

---

## 审查与验收清单
*门禁: 计划进入实现/编码测试前需满足*

### 内容质量
- [ ] 没有实现细节 (不含具体库/系统调用代码)
- [ ] 专注于用户价值与质量保证需要
- [ ] 面向非技术相关者可读
- [ ] 所有强制性章节已完成

### 需求完整性
- [ ] 无剩余 [需要澄清] 标记 (或已迁移至假设并记录)
- [ ] 需求可测试且无歧义
- [ ] 成功标准均可衡量或具可判定条件
- [ ] 范围界定清晰 (排除压力/性能极限)
- [ ] 依赖与假设已列出

---

## 执行状态
*后续推进时勾选*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 模糊之处已标记
- [ ] 用户场景已定义 (需解决澄清项后锁定)
- [ ] 需求已生成 (草稿完成, 待澄清项处理)
- [ ] 实体已识别
- [ ] 审查清单已通过

---

## 当前需要澄清清单
1. 外网可访问验证方式 (端口映射 / 云服务器 / VPN?)
2. 期望行为基线来源 (是否有单独设计文档 / README 权威描述?)
3. 支持与需测试的平台矩阵 (Linux / macOS / Windows?)
4. HTTP 错误响应策略 (畸形、未知方法、超长头)
5. Buffer / 头部大小 / 请求行长度上限数值
6. 必需配置字段清单及缺失时的错误形式
7. 日志格式标准 (时间格式, 级别集合, 分隔符)
8. CPU 占用阈值测量基线以及测试环境硬件规格
9. CI 是否存在 (若无需列出后续接入方案)

## 初步假设 (在澄清前暂用)
1. 目标平台优先 macOS, Windows IOCP 可暂做未来扩展。
2. HTTP 畸形请求统一关闭连接不返回正文。
3. 未知方法返回 501。
4. Buffer 自动扩容至最大上限 (暂设 1MB) 后再拒绝。
5. CPU 占用测试以 4C 开发机为基准。

---

（本规格完成后下一步：生成测试计划/矩阵文件，编写或补充单元 + 组件 + 冒烟 + 基础环境脚本。）

